<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="icon" href="./icon.png">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="./styling.css" />
    <script src="./currency.js"></script>
    <title>Valeria Wallet</title>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/6.5.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.1.0/firebase-database.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
      https://firebase.google.com/docs/web/setup#config-web-app -->

    <script>
        // Your web app's Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyDP1U9RPyFPkNI-oOJRFABg-kNzLX_GGb0",
            authDomain: "valeriawallet-61550.firebaseapp.com",
            databaseURL: "https://valeriawallet-61550.firebaseio.com",
            projectId: "valeriawallet-61550",
            storageBucket: "",
            messagingSenderId: "465422731114",
            appId: "1:465422731114:web:9fbab72a7bdc0f27"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        let wallet = {
            gold: 2,
            magic: 1,
            attack: 0,
            win: 0
        };

        let changes = {
            gold: 0,
            magic: 0,
            attack: 0,
            win: 0
        }

        function addValue(propName, value) {
            changes[propName] += value;
            updateChangeString();
        }

        function updateChangeString() {
            Object.keys(changes).forEach(k => {
                let selectedChange = window.document.getElementsByClassName(`changes ${k}`);
                if (selectedChange.length) {
                    if (changes[k] !== 0) {
                        selectedChange[0].innerHTML = changes[k] > 0 ? `+${changes[k]}` : `${changes[k]}`;
                    } else {
                        selectedChange[0].innerHTML = '';
                    }
                }
            })
        }

        async function setChanges() {
            let isValid = true;
            let invalidKeys = [];

            Object.keys(changes).forEach(k => {
                if ((changes[k] + currentGame.players[playerIndex].wallet[k]) < 0) {
                    isValid = false;
                    invalidKeys.push(k);
                }
            })

            if (isValid) {
                Object.keys(changes).forEach(k => {
                    currentGame.players[playerIndex].wallet[k] += changes[k];
                    let selectedRow = window.document.getElementById(k);
                    if (selectedRow) {
                        let element = selectedRow.getElementsByClassName('currentValue');
                        if (element.length) {
                            element[0].value = currentGame.players[playerIndex].wallet[k];
                        }
                    }
                    changes[k] = 0;
                })
            } else {
                alert(`Can't reduce ${invalidKeys.join(' and ')} below zero`);
            }

            await updateGame();
            updateChangeString();
        }

        async function updateGame() {
            await firebase.database().ref(`/games/${currentGame.gameId}`).set(currentGame);
        }

        function renderScreen() {
            let container = document.getElementsByClassName('currencyRows');
            if (container.length) {
                container[0].innerHTML = '';
            }

            let rowsHtml = ['gold', 'magic', 'attack', 'win'].map(propName => getCurrencyHTML(propName));
            for (let currHTML of rowsHtml) {
                let container = document.getElementsByClassName('currencyRows');
                if (container.length) {
                    container[0].innerHTML += currHTML;
                }
            }
        }

        let gameId;
        let currentGame;
        let playerIndex;
        let userName;

        async function refreshGame(gameId) {
            let game = firebase.database().ref('/games/' + gameId);

            game.on('value', function(snapshot) {

                let newVal = snapshot.val();
                if (newVal) {
                    currentGame = newVal;
                    setPlayerId();
                    renderPlayersTable();
                }
            });

            let curr = await game.once('value');
            let val = curr.val();
            if (val) {
                currentGame = val;
            }
        }

        function renderPlayersTable() {
            let container = document.getElementById('playerTable');
            container.innerHTML = '';

            if (!currentGame) {
                return;
            }

            let playersString = currentGame.players.map((p, i) => {
                return `<tr>
                        <td ${i === playerIndex ? 'class="currentPlayer"': ''}>${p.name}</td>
                        <td class="gold">${p.wallet.gold}</td>
                        <td class="magic">${p.wallet.magic}</td>
                        <td class="attack">${p.wallet.attack}</td>
                        <td class="win">${p.wallet.win}</td>
                    </tr>`
                return `<tr><td>${p.name}</td><td>${p.wallet.gold}</td><td>${p.wallet.magic}</td><td>${p.wallet.attack}</td><td>${p.wallet.win}</td></tr>`
            }).join("");

            container.innerHTML = `
            <table width="100%">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th class="gold">Gold</th>
                        <th class="magic">Magic</th>
                        <th class="attack">Attack</th>
                        <th class="win">Victory</th>
                    </tr>
                </thead>
                <tbody>
                    ${playersString}
                </tbody>
            </table>
            `;
        }

        function setPlayerId() {

            if (!playerIndex) {
                let index = 0;
                for (let currPlayer of currentGame.players) {
                    if (currPlayer.name === userName) {
                        playerIndex = index;
                        break;
                    }

                    index++;
                }
            }
        }

        async function initPage() {

            var urlParams = new URLSearchParams(location.search);
            let gameId = urlParams.get(`gameId`);
            userName = urlParams.get('userName');
            await refreshGame(gameId);

            renderScreen();
            updateChangeString();
            setChanges();
        }
    </script>
</head>

<body onload="initPage()">
    <h1 align="center">Valeria Wallet</h1>
    <div class="wallet container">
        <div class="d-flex justify-content-around">
            <div class="p-2">
                <label class="changes gold"></label>
            </div>
            <div class="p-2">
                <label class="changes magic"></label>
            </div>
            <div class="p-2">
                <label class="changes attack"></label>
            </div>
            <div class="p-2">
                <label class="changes win"></label>
            </div>
        </div>
        <div class="d-flex justify-content-around">
            <div class="p2 align-items-center">
                <input type="button" class="apply" onClick="setChanges()" value="Apply" />
            </div>
        </div>
        <br>
        <div class="currencyRows">
        </div>
        <br>
        <br>
        <br>
        <div id="playerTable">

        </div>
    </div>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>

</html>